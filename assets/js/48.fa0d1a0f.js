(window.webpackJsonp=window.webpackJsonp||[]).push([[48],{425:function(s,a,n){"use strict";n.r(a);var e=n(1),l=Object(e.a)({},(function(){var s=this,a=s.$createElement,n=s._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"mysql主从配置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#mysql主从配置"}},[s._v("#")]),s._v(" MySQL主从配置")]),s._v(" "),n("p",[s._v("首先准备两个MySQL服务器,具体mysql安装教程之前文章有介绍.")]),s._v(" "),n("h3",{attrs:{id:"创建master"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#创建master"}},[s._v("#")]),s._v(" 创建master")]),s._v(" "),n("p",[s._v("推荐是用"),n("code",[s._v("mysqld_multi")]),s._v("管理mysql服务器")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("[mysqld_multi]\nmysqld=/usr/local/mysql/bin/mysqld_safe\n\n[mysqld1]\n# 基础配置\nport=3306\nuser=root\nbasedir\t= /usr/local/mysql\ndatadir=/mysql/3306/data\npid-file = /mysql/3306/mysql.pid\nsocket=/mysql/3306/mysql.sock\nlog_error=/mysql/3306/error.log\n\n\n# 服务器id,必须\nserver-id=1\n# 开机二进制日志\nlog-bin=/mysql/3306/mysqlbin\n# 可以忽略\nbinlog-ignore-db=mysql \n# 需要复制的数据库,必须\nbinlog-do-db=test\n# STATEMENT不能解决时间函数的问题\n# ROW记录每一行的改变，效率低\n# MIXED自动切换，如果存在函数就用ROW，否则使用STATEMENT\nbinlog_format=mixed\n# 二进制缓存大小\nbinlog_cache_size=4M\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br")])]),n("p",[s._v("启动master")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("mysqld_multi --defaults-file=/root/mysql/my_multi.cnf start 1\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("创建用于同步数据的账户")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("# 连接到master节点: mysql -uroot -p -S /mysql/3306/mysql.sock\nGRANT REPLICATION SLAVE ON *.* TO 'slave'@'%' IDENTIFIED BY '123456';\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("查看master状态和复制起始点")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("show master status;\n\n# File为复制的文件 Position为开始复制的接入点\n+-----------------+----------+--------------+------------------+-------------------+\n| File            | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |\n+-----------------+----------+--------------+------------------+-------------------+\n| mysqlbin.000001 |      682 | test         | mysql            |                   |\n+-----------------+----------+--------------+------------------+-------------------+\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("h3",{attrs:{id:"创建slave节点"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#创建slave节点"}},[s._v("#")]),s._v(" 创建slave节点")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("[mysqld2]\nport=3307\nuser=root\nbasedir\t= /usr/local/mysql\ndatadir=/mysql/3307/data\nsocket=/mysql/3307/mysql.sock\npid-file = /mysql/3307/mysql.pid\nsocket=/mysql/3307/mysql.sock\nlog_error=/mysql/3307/error.log\n\nserver-id=2\nrelay-log=mysql-relay\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br")])]),n("p",[s._v("启动slave节点")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("mysqld_multi --defaults-file=/root/mysql/my_multi.cnf start 2\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("连接master")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("CHANGE MASTER TO MASTER_HOST='127.0.0.1',\nMASTER_PORT=3307,\nMASTER_USER='slave',\nMASTER_PASSWORD='123456',\n# 主节点当前logbin文件\nMASTER_LOG_FILE='mysqlbin.000001',\n# logbin文件的偏移值\nMASTER_LOG_POS=682;\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("p",[s._v("开始复制")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("start slave;\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("查看连接状态")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("show slave status \\G;\n# 下面两个同时为yes,表示成功\n -----------------------------------\n Slave_IO_Running: Yes\n Slave_SQL_Running: Yes\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("p",[s._v("连接主机失败时,重试，也可以用以下命令提升slave为主节点")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("stop slave;\nreset master;\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("h3",{attrs:{id:"配置多个主节点"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#配置多个主节点"}},[s._v("#")]),s._v(" 配置多个主节点")]),s._v(" "),n("p",[s._v("只要开启了binlog功能的mysql服务器就支持同步数据,支持数据同步就支持做为主节点.")]),s._v(" "),n("p",[s._v("所以我们配置多个开启binlog的mysql服务器,然后设置互为主从模式就能实现多个主节点共存.")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("[mysqld_multi]\nmysqld=/usr/local/mysql/bin/mysqld_safe\n\n[mysqld1]\nport=3306\nuser=root\nbasedir\t= /usr/local/mysql\ndatadir=/mysql/3306/data\npid-file = /mysql/3306/mysql.pid\nsocket=/mysql/3306/mysql.sock\nlog_error=/mysql/3306/error.log\n\nserver-id=1\n# 自增列从2开始\nauto_increment_offset = 1\n# 每次递增的步长\nauto_increment_increment = 2\nlog-slave-updates = true \nrelay-log=mysql-relay\nlog-bin=/mysql/3306/mysqlbin\nbinlog-ignore-db=mysql \nbinlog-do-db=test\nbinlog_format=mixed\nbinlog_cache_size=4M\n\n[mysqld2]\nport=3307\nuser=root\nbasedir\t= /usr/local/mysql\ndatadir=/mysql/3307/data\npid-file = /mysql/3307/mysql.pid\nsocket=/mysql/3307/mysql.sock\nlog_error=/mysql/3307/error.log\n\nserver-id=2\nauto_increment_offset = 2\nauto_increment_increment = 2\nlog-slave-updates = true \nrelay-log=mysql-relay\nlog-bin=/mysql/3307/mysqlbin\nbinlog-ignore-db=mysql \nbinlog-do-db=test\nbinlog_format=mixed\nbinlog_cache_size=4M\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br")])]),n("p",[s._v("这里需要注意的是防止插入过快导致id重复报错,所以设置不同的起始id,步长设置为主节点数")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("[mysqld1]\nauto_increment_offset = 1\nauto_increment_increment = 2\nrelay-log=mysql-relay\nlog-slave-updates = true\n[mysqld2]\nauto_increment_offset = 2\nauto_increment_increment = 2\nrelay-log=mysql-relay\nlog-slave-updates = true \n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("p",[s._v("相互连接")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("mysql:3306> CHANGE MASTER TO MASTER_HOST='127.0.0.1',\n            MASTER_PORT=3307,\n            MASTER_USER='slave',\n            MASTER_PASSWORD='123456',\n            MASTER_LOG_FILE='mysqlbin.000001',\n            MASTER_LOG_POS=154;\nmysql:3307> CHANGE MASTER TO MASTER_HOST='127.0.0.1',\n            MASTER_PORT=3306,\n            MASTER_USER='slave',\n            MASTER_PASSWORD='123456',\n            MASTER_LOG_FILE='mysqlbin.000001',\n            MASTER_LOG_POS=154;\nmysql:3306> start slave;\nmysql:3307> start slave;\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("p",[s._v("这就是配置多主的所有步骤.")]),s._v(" "),n("p",[s._v("多主多从虽然能增加mysql的连接数，但是数据会始终同步到一张表中，对插入速度并不会有任何提高，而且还会导致每次插入id都递增2而造成id不连续，浪费id空间。")]),s._v(" "),n("h3",{attrs:{id:"读写分离"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#读写分离"}},[s._v("#")]),s._v(" 读写分离")]),s._v(" "),n("h4",{attrs:{id:"读写分离的三种方式"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#读写分离的三种方式"}},[s._v("#")]),s._v(" 读写分离的三种方式")]),s._v(" "),n("ol",[n("li",[n("p",[s._v("通过用户权限实现（推荐）")]),s._v(" "),n("p",[s._v("分别在主/从服务上创建读/写账号：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code")]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"})])])]),s._v(" "),n("p",[s._v("GRANT Select ON "),n("em",[s._v(".")]),s._v(" TO 'reader'@'%'  IDENTIFIED BY \"123456\";\nGRANT Select,Alter,Create,INDEX,Insert,Delete,Update ON "),n("em",[s._v(".")]),s._v(" TO 'writer'@'%'  IDENTIFIED BY \"123456\";\n```")]),s._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",[n("code",[s._v("使用不同的账号连接数据库就实现了读写分离。\n")])])]),n("ol",{attrs:{start:"2"}},[n("li",[n("p",[s._v("通过配置文件（不推荐）")]),s._v(" "),n("p",[s._v("只有确认某个主机永远不会执行写操作时才使用配置文件设置为只读")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("[mysqld]\nread_only=1\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("通过sql命令（配合第一种方式使用）")]),s._v(" "),n("p",[s._v("该命令需要超级管理员才有权限执行，在自动切换主从时有用")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("set global read_only=1;\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])])])]),s._v(" "),n("h2",{attrs:{id:"故障恢复"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#故障恢复"}},[s._v("#")]),s._v(" 故障恢复")]),s._v(" "),n("ol",[n("li",[n("p",[s._v("如果master宕机后恢复")]),s._v(" "),n("p",[s._v("对新的master节点加全库只读锁，阻止所有写入操作，并计下master节点当前得binlog信息，然后备份数据并恢复到宕机得节点中，恢复完成后让宕机得节点作为slave加入当前master节点。")])]),s._v(" "),n("li",[n("p",[s._v("slave节点宕机后恢复")]),s._v(" "),n("p",[s._v("通常只需要重启slave节点就行，无需其它操作")])])])])}),[],!1,null,null,null);a.default=l.exports}}]);